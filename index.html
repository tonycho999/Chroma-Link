<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chroma Link - Challenge Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --cell-size: 50px; }
        .game-area { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(5, var(--cell-size)); 
            grid-template-rows: repeat(5, var(--cell-size));
            gap: 4px; background: #18181b; padding: 10px; border-radius: 12px;
            position: relative;
        }
        .cell { 
            width: var(--cell-size); height: var(--cell-size); 
            background: #27272a; border-radius: 4px; border: 1px solid #3f3f46;
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; z-index: 10;
        }
        .wall { background: #52525b; cursor: not-allowed; border: 1px solid #71717a; }
        /* ë„êµ¬ ìŠ¤íƒ€ì¼ */
        .mirror-1 { width: 70%; height: 4px; background: #e4e4e7; transform: rotate(-45deg); box-shadow: 0 0 8px white; }
        .mirror-2 { width: 70%; height: 4px; background: #e4e4e7; transform: rotate(45deg); box-shadow: 0 0 8px white; }
        .light-src { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 0 10px currentColor; }
        
        /* ë¹” ë ˆì´ì–´ */
        .beam-layer { position: absolute; inset: 0; pointer-events: none; z-index: 5; mix-blend-mode: screen; }
        .beam-segment { position: absolute; background: white; opacity: 0.6; }

        .tool-btn { position: relative; transition: all 0.2s; }
        .tool-btn.active { ring: 2px solid white; transform: scale(1.1); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;}
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center font-sans">

    <div class="text-center mb-6 max-w-md">
        <div class="flex justify-between items-center mb-2">
            <h1 id="level-name" class="text-2xl font-black text-indigo-400">LEVEL 1</h1>
            <span id="level-goal" class="text-xs bg-zinc-800 px-2 py-1 rounded text-magenta-500">ëª©í‘œ: ë³´ë¼ìƒ‰ ë§Œë“¤ê¸°</span>
        </div>
        <p id="level-hint" class="text-zinc-500 text-sm mb-4">"ë²½ì„ í”¼í•´ ê±°ìš¸ë¡œ ë¹›ì„ ë°˜ì‚¬ì‹œí‚¤ì„¸ìš”."</p>
    </div>

    <div class="game-area">
        <div class="relative">
            <div id="board" class="grid-container border border-zinc-700"></div>
            <div id="beam-visuals" class="beam-layer"></div>
        </div>

        <div class="flex gap-4 bg-zinc-900 p-4 rounded-xl border border-zinc-800" id="toolbar">
            </div>

        <div id="status-msg" class="h-6 text-sm font-bold text-center text-zinc-400">ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>

        <div class="flex gap-4 mt-2">
            <button onclick="resetLevel()" class="text-xs text-zinc-500 hover:text-white underline">ë‹¤ì‹œ í•˜ê¸°</button>
            <button onclick="checkWin()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-lg font-bold text-sm transition">ê²°ê³¼ í™•ì¸</button>
        </div>
    </div>

    <script>
        const SIZE = 5;
        // ë ˆë²¨ ë°ì´í„°: map (0:ë¹ˆì¹¸, 9:ë²½), inventory (ì‚¬ìš© ê°€ëŠ¥ ê°œìˆ˜), target (ëª©í‘œ ì¢Œí‘œ ë° ìƒ‰)
        const levels = [
            {
                id: 1,
                name: "ë²½ ë„ˆë¨¸ì˜ ë¹›",
                hint: "ë²½ ë•Œë¬¸ì— ì§ì§„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±°ìš¸ì„ ì‚¬ìš©í•´ ìš°íšŒí•˜ì„¸ìš”.",
                map: [
                    [0,0,0,0,0],
                    [0,9,9,9,0],
                    [0,0,0,0,0], // ëª©í‘œëŠ” ì´ ë¼ì¸ ì˜¤ë¥¸ìª½ ë
                    [0,0,0,0,0],
                    [0,0,0,0,0]
                ],
                inventory: { R:1, B:1, M2:2 }, // ë¹¨ê°•1, íŒŒë‘1, ê±°ìš¸(\) 2ê°œë§Œ ì¤Œ
                target: { row: 2, color: 'magenta', needed: ['R', 'B'] } 
            },
            {
                id: 2,
                name: "êµì°¨ë¡œ",
                hint: "ë‘ ë¹›ì´ í•œ ì (ê°€ìš´ë°)ì—ì„œ ë§Œë‚˜ ë…¸ë€ìƒ‰ì´ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.",
                map: [
                    [0,0,0,0,0],
                    [0,0,9,0,0],
                    [0,0,0,0,0], // ê°€ìš´ë° 2,2 ì§€ì ì´ ëª©í‘œ
                    [0,0,9,0,0],
                    [0,0,0,0,0]
                ],
                inventory: { R:1, G:1, M1:1, M2:1 },
                target: { row: 2, col: 2, color: 'yellow', needed: ['R', 'G'] } // ì´ë²ˆì—” ê²©ì ë‚´ë¶€ê°€ ëª©í‘œ
            }
        ];

        let currentLevelIdx = 0;
        let grid = [];     // í˜„ì¬ ë°°ì¹˜ ìƒíƒœ
        let inventory = {}; // í˜„ì¬ ë‚¨ì€ ìì›
        let selectedTool = null;

        function startLevel(idx) {
            currentLevelIdx = idx;
            const lv = levels[idx];
            
            // ê¹Šì€ ë³µì‚¬ë¡œ ìƒíƒœ ì´ˆê¸°í™”
            grid = lv.map.map(row => row.map(cell => cell === 9 ? 'WALL' : null));
            inventory = { ...lv.inventory };
            selectedTool = Object.keys(inventory)[0]; // ì²« ë„êµ¬ ìë™ ì„ íƒ

            document.getElementById('level-name').innerText = lv.name;
            document.getElementById('level-hint').innerText = lv.hint;
            
            renderBoard();
            renderToolbar();
            traceBeams(); // ì´ˆê¸° ë¹” ê³„ì‚° (ì•„ë¬´ê²ƒë„ ì—†ì–´ë„)
        }

        function renderToolbar() {
            const bar = document.getElementById('toolbar');
            bar.innerHTML = '';
            Object.keys(inventory).forEach(key => {
                // ì¬ê³ ê°€ 0ì´ì–´ë„ ë²„íŠ¼ì€ ë³´ì—¬ì£¼ë˜ ë¹„í™œì„± ì²˜ë¦¬ ê°€ëŠ¥ (ì—¬ê¸°ì„  ìˆ¨ê¸°ì§€ ì•ŠìŒ)
                const btn = document.createElement('button');
                btn.className = `tool-btn w-10 h-10 bg-zinc-700 rounded flex items-center justify-center ${selectedTool === key ? 'active bg-zinc-600' : ''}`;
                btn.onclick = () => { selectedTool = key; renderToolbar(); };
                
                // ì•„ì´ì½˜ í‘œì‹œ
                let icon = '';
                if(key==='R') icon = '<div class="w-4 h-4 rounded-full bg-red-500"></div>';
                else if(key==='G') icon = '<div class="w-4 h-4 rounded-full bg-green-500"></div>';
                else if(key==='B') icon = '<div class="w-4 h-4 rounded-full bg-blue-500"></div>';
                else if(key==='M1') icon = '<div class="mirror-1 w-6"></div>';
                else if(key==='M2') icon = '<div class="mirror-2 w-6"></div>';
                
                btn.innerHTML = `${icon} <div class="badge">${inventory[key]}</div>`;
                bar.appendChild(btn);
            });
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            grid.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const el = document.createElement('div');
                    el.className = `cell ${cell === 'WALL' ? 'wall' : ''}`;
                    
                    // ë²½ì´ ì•„ë‹ˆë©´ í´ë¦­ ì´ë²¤íŠ¸
                    if (cell !== 'WALL') {
                        el.onclick = () => handleCellClick(r, c);
                    }

                    // ì•„ì´ì½˜ ë Œë”ë§
                    if (cell && cell !== 'WALL') {
                        if(['R','G','B'].includes(cell)) {
                            el.innerHTML = `<div class="light-src" style="background:${cell==='R'?'red':cell==='G'?'lime':'blue'}; color:${cell==='R'?'red':cell==='G'?'lime':'blue'}"></div>`;
                        } else if (cell === 'M1') el.innerHTML = `<div class="mirror-1"></div>`;
                        else if (cell === 'M2') el.innerHTML = `<div class="mirror-2"></div>`;
                    }
                    
                    // ëª©í‘œ ì§€ì  í‘œì‹œ (ì™¸ê³½ or ë‚´ë¶€)
                    const lv = levels[currentLevelIdx];
                    if (lv.target.col === c && lv.target.row === r) {
                        el.style.border = '2px dashed white';
                    }

                    board.appendChild(el);
                });
            });
        }

        function handleCellClick(r, c) {
            const currentVal = grid[r][c];

            // 1. ì´ë¯¸ ë¬´ì–¸ê°€ ìˆë‹¤ë©´ íšŒìˆ˜ (Inventory +1)
            if (currentVal) {
                if (inventory[currentVal] !== undefined) inventory[currentVal]++;
                grid[r][c] = null;
            } 
            // 2. ë¹ˆì¹¸ì´ë¼ë©´ í˜„ì¬ íˆ´ ë°°ì¹˜ (Inventory -1)
            else {
                if (inventory[selectedTool] > 0) {
                    grid[r][c] = selectedTool;
                    inventory[selectedTool]--;
                } else {
                    showMessage("ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!", "text-red-500");
                    return; // ë Œë”ë§ ìŠ¤í‚µ
                }
            }
            
            renderBoard();
            renderToolbar();
            traceBeams();
        }

        // ë¹› ì¶”ì  ë° ì‹œê°í™” (í•µì‹¬ ë¡œì§)
        function traceBeams() {
            const visualLayer = document.getElementById('beam-visuals');
            visualLayer.innerHTML = ''; // ì´ˆê¸°í™”
            const lv = levels[currentLevelIdx];
            
            // ëª©í‘œ ì§€ì ì˜ íˆíŠ¸ ìƒíƒœ í™•ì¸ìš©
            let hits = new Set(); 

            // ëª¨ë“  ê´‘ì› ì°¾ê¸°
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    if(['R','G','B'].includes(grid[r][c])) {
                        fireRay(r, c, grid[r][c], visualLayer, hits);
                    }
                }
            }

            // ìŠ¹ë¦¬ ì¡°ê±´ ì‹¤ì‹œê°„ ì²´í¬
            const t = lv.target;
            // í•„ìš”í•œ ìƒ‰ìƒì´ ëª¨ë‘ ë„ë‹¬í–ˆëŠ”ì§€ í™•ì¸
            const success = t.needed.every(color => hits.has(color));
            
            if(success) showMessage("ëª©í‘œ ë‹¬ì„±! ì •ë‹µì…ë‹ˆë‹¤. ğŸ‰", "text-green-400");
            else showMessage("ë°°ì¹˜ ì¤‘...", "text-zinc-500");
        }

        function fireRay(r, c, color, layer, hits) {
            let cr = r, cc = c;
            let dr = 0, dc = 1; // ê¸°ë³¸: ì˜¤ë¥¸ìª½ ë°œì‚¬
            const maxStep = 20; // ë¬´í•œë£¨í”„ ë°©ì§€
            
            for(let step=0; step<maxStep; step++) {
                // í˜„ì¬ ì¹¸ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚° (ì‹œê°í™”ìš©)
                const x1 = cc * 54 + 27; // cell size + gap rough calc
                const y1 = cr * 54 + 27;
                
                // ë‹¤ìŒ ì¹¸ ì´ë™
                const nr = cr + dr; 
                const nc = cc + dc;
                
                // ë²½ì´ë‚˜ ë§µ ëì´ë©´ ì¢…ë£Œ
                if (nr < 0 || nr >= SIZE || nc < 0 || nc >= SIZE || grid[nr][nc] === 'WALL') {
                    // ëª©í‘œ ì§€ì  ë„ë‹¬ ì²´í¬ (ì™¸ê³½ íƒ€ê²Ÿì¸ ê²½ìš° ë¡œì§ ì¶”ê°€ í•„ìš”í•˜ë‚˜ ì—¬ê¸°ì„  ë‚´ë¶€/ê²½ê³„ ë‹¨ìˆœí™”)
                    // í˜„ì¬ ë¡œì§ì€ 'ë¹›ì´ ì§€ë‚˜ê°„ ê²½ë¡œ'ê°€ ì•„ë‹ˆë¼ 'ë¹›ì´ ë©ˆì¶˜ ê³³'ë§Œ ì²´í¬í•˜ì§€ ì•Šê³ 
                    // í•´ë‹¹ ì¢Œí‘œê°€ íƒ€ê²Ÿ ì¢Œí‘œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ë´…ë‹ˆë‹¤.
                    
                    // ì™¸ê³½ ëª©í‘œ ì²´í¬ (ë³´ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ìˆœê°„)
                    const lv = levels[currentLevelIdx];
                    if (!lv.target.col && nr === lv.target.row && nc === SIZE) { 
                        // ì˜¤ë¥¸ìª½ ë ì™¸ê³½ íƒ€ê²Ÿì¸ ê²½ìš°
                        hits.add(color);
                    }
                    drawBeam(layer, x1, y1, x1 + dc*25, y1 + dr*25, color); // ë²½ì— ë¶€ë”ªíŒ íš¨ê³¼
                    break;
                }

                // ì´ë™
                cr = nr; cc = nc;
                const x2 = cc * 54 + 27;
                const y2 = cr * 54 + 27;
                
                // ì„  ê·¸ë¦¬ê¸°
                drawBeam(layer, x1, y1, x2, y2, color);

                // ë‚´ë¶€ íƒ€ê²Ÿ ì²´í¬
                const lv = levels[currentLevelIdx];
                if (lv.target.col === cc && lv.target.row === cr) {
                    hits.add(color);
                }

                // ê±°ìš¸ ì²´í¬ ë° êµ´ì ˆ
                const item = grid[cr][cc];
                if (item === 'M1') { // ìŠ¬ë˜ì‹œ / : (0,1)->(-1,0) ìœ„ë¡œ, (0,-1)->(1,0) ì•„ë˜ë¡œ
                    [dr, dc] = [-dc, -dr]; 
                } else if (item === 'M2') { // ì—­ìŠ¬ë˜ì‹œ \ : (0,1)->(1,0) ì•„ë˜ë¡œ
                    [dr, dc] = [dc, dr];
                }
            }
        }

        function drawBeam(layer, x1, y1, x2, y2, color) {
            const line = document.createElement('div');
            // CSSë¡œ ì„  ê·¸ë¦¬ê¸° (íšŒì „ ë° ê¸¸ì´ ê³„ì‚°)
            const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
            const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;
            
            line.style.position = 'absolute';
            line.style.left = `${x1}px`;
            line.style.top = `${y1 - 2}px`; // ì¤‘ì•™ ì •ë ¬ ë³´ì •
            line.style.width = `${length}px`;
            line.style.height = '4px';
            line.style.backgroundColor = color === 'R' ? '#ff3333' : color === 'G' ? '#33ff33' : '#3333ff';
            line.style.transform = `rotate(${angle}deg)`;
            line.style.transformOrigin = '0 50%';
            line.style.borderRadius = '2px';
            line.style.boxShadow = `0 0 8px ${line.style.backgroundColor}`;
            
            layer.appendChild(line);
        }

        function showMessage(msg, colorClass) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.className = `h-6 text-sm font-bold text-center ${colorClass}`;
        }

        function resetLevel() { startLevel(currentLevelIdx); }
        function checkWin() { /* ì‹¤ì‹œê°„ ì²´í¬ë¡œ ëŒ€ì²´ë¨ */ }

        startLevel(0); // ê²Œì„ ì‹œì‘
    </script>
</body>
</html>
